<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login - KrishiVyaparSETU</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Font Awesome (for eye icons) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <style>
    /* Page background (replace or remove URL if not needed) */
    body {
      background: url("/static/assets/images/bg.jpg") no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Card */
    .login-card {
      width: 100%;
      max-width: 420px;
      background: rgba(255, 255, 255, 0.541);
      border-radius: 12px;
      padding: 1.75rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }

    .logo {
      width: 88px;
      height: 88px;
      border-radius: 50%;
      display:block;
      margin: 0 auto 12px auto;
      object-fit: cover;
      border: 3px solid #28a745;
    }

    /* Role buttons */
        .role-button {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .role-button.selected {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.7);
      background-color: #28a745 !important;
      color: white !important;
    }

    .role-button:not(.selected) {
      background-color: #ffffff;
      color: #28a745;
    }

    .role-button:hover {
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }
    .error-message {
      color: #dc3545;
      font-size: .875rem;
      margin-top: .35rem;
    }

    /* Input-group adjustments so icon looks inline inside input */
    .input-group .form-control {
      border-right: 0;
    }
    .input-group .input-group-text {
      background: transparent;
      border-left: 0;
      cursor: pointer;
      color: #6c757d;
    }
    .input-group:focus-within .input-group-text {
      color: #198754;
    }

    /* Toasts */
    .toast-container-custom {
      position: fixed;
      top: 18px;
      right: 18px;
      z-index: 1100;
    }
    .custom-toast {
      background-color: #198754;
      color: #fff;
      padding: .6rem .9rem;
      border-radius: .5rem;
      margin-bottom: .5rem;
      transform: translateY(-8px);
      opacity: 0;
      transition: transform .22s, opacity .22s;
      box-shadow: 0 8px 22px rgba(0,0,0,0.12);
    }
    .custom-toast.show { transform: translateY(0); opacity: 1; }
    .custom-toast.error { background: #dc3545; }

    @media (max-width: 480px) {
      .login-card { margin: 12px; padding: 1rem; }
    }
  </style>
</head>
<body>
   <div class="container text-start" style="position: absolute; top: 50px; left: 50%; transform: translateX(-50%); max-width: 820px; z-index: 1;">
    <button class="btn btn-outline-secondary btn-sm" onclick="history.back()">â¬… Back</button>
  </div>
  <div class="login-card">
    <img src="/static/assets/images/logo.jpg" alt="KrishiVyaparSETU Logo" class="logo" />
    <h3 class="text-center text-success mb-3">Login</h3>

    <!-- Role selection -->
    <div class="mb-3 text-center" role="radiogroup" aria-label="Select role">
      <button type="button" class="btn btn-sm role-button me-2" id="role-farmer" aria-pressed="false">Farmer</button>
      <button type="button" class="btn btn-sm role-button" id="role-trader" aria-pressed="false">Trader</button>
      <div id="role-error" class="error-message visually-hidden" role="alert">Please select a role.</div>
    </div>

    <!-- Login form -->
    <form id="login-form" action="/login" method="POST" novalidate>
      <input type="hidden" name="role" id="role-hidden" />
      <div class="mb-3">
        <label for="identifier" class="form-label" placeholder="enter valid email or mobile number">Email or Mobile Number</label>
        <input type="text" name="identifier" id="identifier" class="form-control" autocomplete="email" />
        <div id="identifier-error" class="error-message visually-hidden">Please enter a valid email or mobile number.</div>
      </div>

      <div class="mb-3">
        <label for="password" class="form-label" placeholder="enter valid password">Password</label>
        <div class="input-group">
          <input type="password" name="password" id="password" class="form-control" autocomplete="current-password" minlength="6" />
          <span class="input-group-text" id="toggle-password" title="Show / Hide password" role="button" aria-pressed="false">
            <i class="fa-solid fa-eye-slash" id="password-icon" aria-hidden="true"></i>
          </span>
        </div>
        <div id="password-error" class="error-message visually-hidden">enter valid password.</div>
      </div>

      <button type="submit" class="btn btn-success w-100" id="login-btn">Login</button>
    </form>

    <div class="text-center mt-3">
      <button type="button" class="btn btn-link p-0" id="forgot-password-btn" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal">Forgot Password?</button>
    </div>

    <p class="text-center mt-3 small">Don't have an account? <a href="/register">Register</a></p>
  </div>

  <!-- Forgot Password Modal with full 3-step flow -->
  <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="forgot-password-form" novalidate>
          <div class="modal-header">
            <h5 class="modal-title">Forgot Password</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <!-- Step 1 -->
            <div id="fp-step-1">
              <label class="form-label">Choose how to receive OTP</label>
              <div class="mb-2">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="fp-method" id="fp-method-email" value="email" checked>
                  <label class="form-check-label" for="fp-method-email">Email</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="fp-method" id="fp-method-phone" value="phone">
                  <label class="form-check-label" for="fp-method-phone">Phone</label>
                </div>
              </div>

              <div class="mb-3">
                <label for="fp-identifier" class="form-label">Enter your registered email or mobile number</label>
                <input type="text" id="fp-identifier" class="form-control" autocomplete="email" />
                <div id="fp-identifier-error" class="error-message visually-hidden">Please enter a valid email or mobile number.</div>
              </div>
            </div>

            <!-- Step 2 -->
            <div id="fp-step-2" class="d-none">
              <div class="mb-3">
                <label for="fp-otp" id="fp-otp-label" class="form-label">Enter OTP</label>
                <input type="text" id="fp-otp" class="form-control" maxlength="6" autocomplete="one-time-code" />
                <div id="fp-otp-error" class="error-message visually-hidden">Please enter the 6-digit OTP.</div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <button type="button" id="resend-otp-btn" class="btn btn-link p-0" aria-disabled="true">Resend OTP</button>
                <span id="resend-otp-timer" class="text-muted small"></span>
              </div>
            </div>

            <!-- Step 3 -->
            <div id="fp-step-3" class="d-none">
              <div class="mb-3">
                <label for="fp-new-password" class="form-label">New Password</label>
                <div class="input-group">
                  <input type="password" id="fp-new-password" class="form-control" minlength="6" autocomplete="new-password" />
                  <span class="input-group-text password-toggle-btn" data-target="fp-new-password" title="Show / Hide" role="button">
                    <i class="fa-solid fa-eye-slash"></i>
                  </span>
                </div>
                <div id="fp-new-password-error" class="error-message visually-hidden">Password must be at least 6 characters.</div>
                <div class="form-text small">Strong password: include uppercase, number & symbol (optional).</div>
              </div>

              <div class="mb-3">
                <label for="fp-confirm-password" class="form-label">Confirm New Password</label>
                <div class="input-group">
                  <input type="password" id="fp-confirm-password" class="form-control" minlength="6" autocomplete="new-password" />
                  <span class="input-group-text password-toggle-btn" data-target="fp-confirm-password" title="Show / Hide" role="button">
                    <i class="fa-solid fa-eye-slash"></i>
                  </span>
                </div>
                <div id="fp-confirm-password-error" class="error-message visually-hidden">Passwords do not match.</div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="fp-cancel-btn">Cancel</button>
            <button type="submit" class="btn btn-success" id="fp-next-btn">Next</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container-custom" id="toast-container"></div>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /*******************************
     * Configuration: mockMode
     * - mockMode = true: simulate backend (works offline)
     * - mockMode = false: real fetch calls to endpoints (placeholders present)
     *******************************/
    const mockMode = false; // set to false when integrating real backend

    /***********************
     * Toast helper
     ***********************/
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const el = document.createElement('div');
      el.className = 'custom-toast' + (type === 'error' ? ' error' : '');
      el.setAttribute('role', 'status');
      el.setAttribute('aria-live', 'polite');
      el.textContent = message;
      container.appendChild(el);
      requestAnimationFrame(() => el.classList.add('show'));
      setTimeout(() => {
        el.classList.remove('show');
        setTimeout(() => el.remove(), 240);
      }, 3000);
    }

    /*******************************
     * Role selection
     *******************************/
    let selectedRole = null;
    const roleFarmer = document.getElementById('role-farmer');
    const roleTrader = document.getElementById('role-trader');
    const roleError = document.getElementById('role-error');

    function setRole(role) {
      selectedRole = role;
      roleFarmer.classList.toggle('selected', role === 'farmer');
      roleTrader.classList.toggle('selected', role === 'trader');
      roleFarmer.setAttribute('aria-pressed', role === 'farmer');
      roleTrader.setAttribute('aria-pressed', role === 'trader');
      roleError.classList.add('visually-hidden');
      document.getElementById('role-hidden').value = role;
    }

    roleFarmer.addEventListener('click', () => setRole('farmer'));
    roleTrader.addEventListener('click', () => setRole('trader'));
    // keyboard support
    [roleFarmer, roleTrader].forEach(btn => {
      btn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); }
      });
    });

    /*******************************
     * Inline eye toggle (login)
     *******************************/
    const togglePassword = document.getElementById('toggle-password');
    const passwordInput = document.getElementById('password');
    const passwordIcon = document.getElementById('password-icon');

    togglePassword.addEventListener('click', () => {
      const isPwd = passwordInput.type === 'password';
      passwordInput.type = isPwd ? 'text' : 'password';
      passwordIcon.classList.toggle('fa-eye');
      passwordIcon.classList.toggle('fa-eye-slash');
      togglePassword.setAttribute('aria-pressed', String(!isPwd));
    });

    // also allow toggle by pressing Enter/Space when focused on icon
    togglePassword.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); togglePassword.click(); }
    });

    /*******************************
     * Login form validation & submit
     *******************************/
    const loginForm = document.getElementById('login-form');

    function validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email).toLowerCase());
    }
    function validateMobile(mobile) {
      return /^[6-9]\d{9}$/.test(String(mobile));
    }

    function clearLoginErrors() {
      roleError.classList.add('visually-hidden');
      document.getElementById('identifier-error').classList.add('visually-hidden');
      document.getElementById('password-error').classList.add('visually-hidden');
    }

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      clearLoginErrors();

      let valid = true;
      const idVal = document.getElementById('identifier').value.trim();
      const pwdVal = passwordInput.value;

      if (!selectedRole) {
        roleError.classList.remove('visually-hidden');
        valid = false;
      }

      if (!idVal || (idVal.includes('@') ? !validateEmail(idVal) : !validateMobile(idVal))) {
        document.getElementById('identifier-error').classList.remove('visually-hidden');
        valid = false;
      }

      if (!pwdVal || pwdVal.length < 6) {
        document.getElementById('password-error').classList.remove('visually-hidden');
        valid = false;
      }

      if (!valid) return;

      // Replace this with actual backend login if available
      showToast('Login validated (demo).', 'success');
      // loginForm.submit(); // uncomment to perform regular POST
    });

    /**************************************
     * Forgot Password Modal & Flow
     **************************************/
    const forgotModalEl = document.getElementById('forgotPasswordModal');
    const forgotModal = new bootstrap.Modal(forgotModalEl, { backdrop: 'static', keyboard: false });
    const forgotBtn = document.getElementById('forgot-password-btn');

    const forgotForm = document.getElementById('forgot-password-form');
    const fpStep1 = document.getElementById('fp-step-1');
    const fpStep2 = document.getElementById('fp-step-2');
    const fpStep3 = document.getElementById('fp-step-3');
    const fpNextBtn = document.getElementById('fp-next-btn');

    const fpIdentifier = document.getElementById('fp-identifier');
    const fpOtpInput = document.getElementById('fp-otp');
    const resendBtn = document.getElementById('resend-otp-btn');
    const resendTimerText = document.getElementById('resend-otp-timer');

    const passwordToggleButtons = document.querySelectorAll('.password-toggle-btn');

    // toggle for modal password fields
    passwordToggleButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-target');
        const input = document.getElementById(targetId);
        if (!input) return;
        const icon = btn.querySelector('i');
        const isPwd = input.type === 'password';
        input.type = isPwd ? 'text' : 'password';
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
      });
    });

    // Steps state
    let currentStep = 1;
    let resendInterval = null;
    let resendSeconds = 0;
    let selectedMethod = 'email'; // email or phone

    // method radio change
    document.querySelectorAll('input[name="fp-method"]').forEach(r => {
      r.addEventListener('change', (e) => {
        selectedMethod = e.target.value;
        updateFpOtpLabel();
      });
    });

    function updateFpOtpLabel() {
      const label = document.getElementById('fp-otp-label');
      if (label) label.textContent = `Enter OTP sent to your ${selectedMethod}`;
    }
    updateFpOtpLabel();

    // Reset and open modal
    forgotBtn.addEventListener('click', () => {
      resetForgotForm();
      forgotModal.show();
    });

    forgotModalEl.addEventListener('hidden.bs.modal', () => {
      resetForgotForm();
    });

    function resetForgotForm() {
      currentStep = 1;
      clearInterval(resendInterval);
      resendInterval = null;
      resendSeconds = 0;
      fpNextBtn.disabled = false;
      fpNextBtn.textContent = 'Next';
      fpStep1.classList.remove('d-none');
      fpStep2.classList.add('d-none');
      fpStep3.classList.add('d-none');
      resendBtn.disabled = true;
      resendTimerText.textContent = '';
      forgotForm.reset();
      clearFpErrors();
    }

    function clearFpErrors() {
      ['fp-identifier','fp-otp','fp-new-password','fp-confirm-password'].forEach(id => {
        const err = document.getElementById(id + '-error');
        if (err) err.classList.add('visually-hidden');
        const input = document.getElementById(id);
        if (input) input.setAttribute('aria-invalid', 'false');
      });
    }

    // OTP realtime enable/disable
    fpOtpInput.addEventListener('input', () => {
      const val = fpOtpInput.value.trim();
      fpNextBtn.disabled = !/^\d{6}$/.test(val);
    });

    forgotForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearFpErrors();

      if (currentStep === 1) {
        const val = fpIdentifier.value.trim();
        if (!val || (selectedMethod === 'email' ? !validateEmail(val) : !validateMobile(val))) {
          document.getElementById('fp-identifier-error').classList.remove('visually-hidden');
          return;
        }
        await sendOTP({ identifier: val, method: selectedMethod, resend: false });
      } else if (currentStep === 2) {
        const otp = fpOtpInput.value.trim();
        if (!/^\d{6}$/.test(otp)) {
          document.getElementById('fp-otp-error').classList.remove('visually-hidden');
          return;
        }
        await verifyOTP({ otp });
      } else if (currentStep === 3) {
        const newPwd = document.getElementById('fp-new-password').value;
        const conf = document.getElementById('fp-confirm-password').value;
        if (!validatePasswordRules(newPwd)) {
          document.getElementById('fp-new-password-error').classList.remove('visually-hidden');
          return;
        }
        if (newPwd !== conf) {
          document.getElementById('fp-confirm-password-error').classList.remove('visually-hidden');
          return;
        }
        await resetPassword({ new_password: newPwd });
      }
    });

    // Resend OTP button
    resendBtn.addEventListener('click', async () => {
      if (resendSeconds > 0) return;
      const val = fpIdentifier.value.trim();
      if (!val) { document.getElementById('fp-identifier-error').classList.remove('visually-hidden'); return; }
      await sendOTP({ identifier: val, method: selectedMethod, resend: true });
    });

    // resend timer
    function startResendTimer(seconds = 30) {
      clearInterval(resendInterval);
      resendSeconds = seconds;
      resendBtn.disabled = true;
      resendTimerText.textContent = ` (${resendSeconds}s)`;
      resendInterval = setInterval(() => {
        resendSeconds--;
        resendTimerText.textContent = resendSeconds > 0 ? ` (${resendSeconds}s)` : '';
        if (resendSeconds <= 0) {
          clearInterval(resendInterval);
          resendBtn.disabled = false;
          resendTimerText.textContent = '';
        }
      }, 1000);
    }

    /*******************************
     * Password rules
     *******************************/
    function validatePasswordRules(pwd) {
      if (!pwd || pwd.length < 8) return false;
      // optional stricter rules:
      // return /^(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/.test(pwd);
      return true;
    }

    /*******************************
     * Network functions (or mocks)
     *******************************/
    async function sendOTP({ identifier, method, resend=false }) {
      // UI: show loading state on button
      setFpButtonLoading(true, resend ? 'Resending...' : 'Sending...');
      try {
        if (mockMode) {
          // simulate server latency
          await new Promise(r => setTimeout(r, 700));
          showToast(resend ? 'OTP resent (demo)' : 'OTP sent (demo)', 'success');
          // move to step 2 if not resend
          if (!resend) {
            currentStep = 2;
            fpStep1.classList.add('d-none');
            fpStep2.classList.remove('d-none');
            fpStep3.classList.add('d-none');
            fpNextBtn.textContent = 'Verify OTP';
            fpNextBtn.disabled = true;
            startResendTimer(30);
          } else {
            startResendTimer(30);
          }
        } else {
          // Real API call: replace URL with your endpoint
          const res = await fetch('/api/send-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ identifier, method })
          });
          const data = await safeJson(res);
          if (res.ok && data && data.success) {
            showToast(data.message || (resend ? 'OTP resent' : 'OTP sent'), 'success');
            if (!resend) {
              currentStep = 2;
              fpStep1.classList.add('d-none');
              fpStep2.classList.remove('d-none');
              fpStep3.classList.add('d-none');
              fpNextBtn.textContent = 'Verify OTP';
              fpNextBtn.disabled = true;
              startResendTimer(30);
            } else {
              startResendTimer(30);
            }
          } else {
            showToast((data && data.message) || 'Failed to send OTP', 'error');
            document.getElementById('fp-identifier-error').classList.remove('visually-hidden');
          }
        }
      } catch (err) {
        console.error('sendOTP error', err);
        showToast('Failed to send OTP. Try again later.', 'error');
      } finally {
        setFpButtonLoading(false);
      }
    }

    async function verifyOTP({ otp }) {
      setFpButtonLoading(true, 'Verifying...');
      try {
        if (mockMode) {
          await new Promise(r => setTimeout(r, 600));
          // mock: accept any 6-digit
          showToast('OTP verified (demo)', 'success');
          currentStep = 3;
          fpStep1.classList.add('d-none');
          fpStep2.classList.add('d-none');
          fpStep3.classList.remove('d-none');
          fpNextBtn.textContent = 'Reset Password';
          fpNextBtn.disabled = false;
        } else {
          const res = await fetch('/api/verify-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ otp })
          });
          const data = await safeJson(res);
          if (res.ok && data && data.success) {
            showToast(data.message || 'OTP verified', 'success');
            currentStep = 3;
            fpStep1.classList.add('d-none');
            fpStep2.classList.add('d-none');
            fpStep3.classList.remove('d-none');
            fpNextBtn.textContent = 'Reset Password';
            fpNextBtn.disabled = false;
          } else {
            showToast((data && data.message) || 'Invalid OTP', 'error');
            document.getElementById('fp-otp-error').classList.remove('visually-hidden');
          }
        }
      } catch (err) {
        console.error('verifyOTP error', err);
        showToast('Failed to verify OTP. Try again later.', 'error');
      } finally {
        setFpButtonLoading(false);
      }
    }

    async function resetPassword({ new_password }) {
      setFpButtonLoading(true, 'Resetting...');
      try {
        if (mockMode) {
          await new Promise(r => setTimeout(r, 600));
          showToast('Password reset successful (demo)', 'success');
          forgotModal.hide();
          resetForgotForm();
        } else {
          const res = await fetch('/api/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ new_password })
          });
          const data = await safeJson(res);
          if (res.ok && data && data.success) {
            showToast(data.message || 'Password reset successful', 'success');
            forgotModal.hide();
            resetForgotForm();
          } else {
            showToast((data && data.message) || 'Failed to reset password', 'error');
          }
        }
      } catch (err) {
        console.error('resetPassword error', err);
        showToast('Failed to reset password. Try again later.', 'error');
      } finally {
        setFpButtonLoading(false);
      }
    }

    async function safeJson(res) {
      try { return await res.json(); } catch (e) { return null; }
    }

    // UI loading state for modal action button
    function setFpButtonLoading(isLoading, text = '') {
      if (!fpNextBtn) return;
      if (isLoading) {
        fpNextBtn.disabled = true;
        fpNextBtn.dataset.orig = fpNextBtn.textContent;
        fpNextBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ' + text;
      } else {
        fpNextBtn.disabled = false;
        fpNextBtn.textContent = fpNextBtn.dataset.orig || 'Next';
      }
    }

    /***************************************
     * Additional accessibility & helpers
     ***************************************/
    // Allow pressing Enter on resend button
    resendBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); resendBtn.click(); }
    });

    // Make sure fpNextBtn is initially enabled only for step 1
    fpNextBtn.disabled = false;

    /***************************************
     * Optional: allow pressing Enter in OTP to submit
     ***************************************/
    fpOtpInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && /^\d{6}$/.test(fpOtpInput.value.trim())) {
        fpNextBtn.click();
      }
    });

    // Expose for debugging in console if needed:
    window._login_helpers = {
      sendOTP, verifyOTP, resetPassword, startResendTimer, mockMode
    };

    // Initialize: ensure modal is reset
    resetForgotForm();
  </script>
</body>
</html>
