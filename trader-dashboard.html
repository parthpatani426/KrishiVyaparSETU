<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trader Dashboard - KrishiVyaparSETU</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

 <!-- MapLibre GL -->
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

  <!-- Turf.js for geometry helpers -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <!-- Export libs (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- TensorFlow.js for potential AI models -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>

  <style>
    :root{
      --brand: #0d6efd; /* blue accent for traders */
    }
    body {
       background: url("/static/assets/images/bg.jpg") no-repeat center center fixed;
      background-size: cover;
    }
    .dashboard-card{
      background:#9e9b9b70; border-radius:14px; box-shadow:0 6px 18px rgba(202, 198, 198, 0.073);
      padding:15px; margin-bottom:20px;
    }
    .dashboard-card h4{ margin-bottom: 0.75rem; }
    .kpi { display:grid; grid-template-columns: repeat(4, minmax(160px,1fr)); gap:12px; }
    .kpi .card{ border-left:5px solid var(--brand); }
    .value{ font-weight:800; font-size:1.4rem; }
    .offcanvas-start{ width: 280px; }

    /* Navbar */
    .nav-icon-btn{ position:relative; }
    .nav-icon-badge{
      position:absolute; top:-6px; right:-6px; min-width:18px; height:18px; line-height:18px;
      font-size:12px; border-radius:999px; background:#dc3545; color:#fff; text-align:center;
      padding:0 4px;
    }
    .avatar{
      width:36px; height:36px; border-radius:50%; background:#e7f0ff; color:var(--brand);
      display:flex; align-items:center; justify-content:center; font-weight:700; border:1px solid #cfe2ff;
    }
    /* Map styles */
 #map { width:100%; height:100%; min-height:540px; border-radius:10px; border:1px solid #d1d5db; }
    .map-col { min-height:540px; }
    .map-wrapper { height:100%; position:relative; }
    .tiny { font-size:.85rem; color:#6b7280; }
    @media (max-width:991px){ .kpi{ grid-template-columns: repeat(2,1fr); } #map{ min-height:420px; } }

    /* Browser Toolbar */
    .browser-toolbar .form-control{ font-family: ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace; }
    iframe.loading{ opacity:.7; pointer-events:none; }
     /* Chat */
    #chatBox{
      height:280px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px; padding:10px; background:#fafbff;
    }
    .msg{ margin:6px 0; display:flex; }
    .msg.me{ justify-content:flex-end; }
    .bubble{
      max-width:70%; padding:8px 12px; border-radius:10px;
      background:#e9f2ff; border:1px solid #d0e2ff;
    }
    .msg.me .bubble{ background:#dff6dd; border-color:#c7ebc5; }
    .tiny{ font-size:.8rem; color:#6c757d; }

    /* Call */
    .call-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    video{ width:100%; background:#000; border-radius:10px; }
    textarea.sdp{font-family: ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace; height:90px;}
    .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 1080; }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-dark" style="background: var(--brand);">
    <div class="container-fluid">
      <button class="btn btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#mainMenu">‚ò∞ Menu</button>
      <span class="navbar-brand fw-bold">üìà KrishiVyaparSETU ‚Äî Trader</span>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-light nav-icon-btn" id="bellBtn" title="Notifications">üîî
          <span class="nav-icon-badge d-none" id="bellBadge">0</span>
        </button>
        <div class="dropdown">
          <button class="btn btn-light d-flex align-items-center gap-2" data-bs-toggle="dropdown" title="Profile">
            <span class="avatar" id="avatarInitials">T</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><h6 class="dropdown-header" id="ddName">Trader</h6></li>
            <li><button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#profileModal">Edit Profile</button></li>
            <li><button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#contactModal">Contact Us</button></li>
            <li><hr class="dropdown-divider"></li>
            <li><button class="dropdown-item text-danger" id="logoutBtn">Logout</button></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- SIDE MENU -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="mainMenu">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Trader Menu</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <nav class="nav flex-column">
        <a class="nav-link" href="#" onclick="openSection('overview')">Dashboard / Overview</a>
        <a class="nav-link" href="#" onclick="openSection('browse')">Browse Crops</a>
        <a class="nav-link" href="#" onclick="openSection('orders')">Orders Management</a>
        <a class="nav-link" href="#" onclick="openSection('weather')">Local Weather</a>
        <a class="nav-link" href="#" onclick="openSection('map')">Chizu</a>
        <a class="nav-link" href="#" onclick="openSection('schemes')">Govt Schemes & Resources</a>
        <a class="nav-link" href="#" onclick="openSection('browser')">Burauza üåê</a>
        <a class="nav-link" href="#" onclick="openSection('chat')">Chat & Calls</a>
        <hr>
        <a class="nav-link" href="#" onclick="openSection('grain')">Grain Quality Scanner üåæ</a>
        <a class="nav-link" href="#" onclick="openSection('prediction')">Price Prediction üìà</a>
      </nav>
    </div>
  </div>
  <div class="container my-3">
    <!-- OVERVIEW -->
    <section class="dashboard-card" id="sec-overview">
      <h4 class="text-primary mb-3">Profile & Overview</h4>
      <div class="row g-3">
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-body">
      <h5 class="card-title">My Profile</h5>
      <div class="mb-2 text-center">
        <img id="profPic" src="" alt="Profile Picture" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 2px solid #0d6efd; display: none;">
        <div id="profPicPlaceholder" class="avatar mx-auto" style="width: 100px; height: 100px; font-size: 2rem;">T</div>
      </div>
      <div class="mb-2">
        <label class="form-label">Name</label>
        <input id="profName" class="form-control" placeholder="Your name">
      </div>
              <div class="mb-2">
                <label class="form-label">Mobile</label>
                <input id="profMobile" class="form-control" placeholder="10-digit mobile" maxlength="10">
              </div>
              <div class="mb-2">
                <label class="form-label">Location</label>
                <input id="profLocation" class="form-control" placeholder="City, State">
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#profileModal">Profile Setup</button>
                <button class="btn btn-primary btn-sm" onclick="saveProfile()">Save</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="loadProfile()">Reload</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="exportLocalDB()">Backup</button>
              </div>
              <div class="text-muted small mt-2">Stored locally for demo.</div>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="kpi mb-3">
            <div class="card"><div class="card-body"><div class="text-muted">Available Listings</div><div class="value" id="kpiListings">0</div></div></div>
            <div class="card"><div class="card-body"><div class="text-muted">Orders Placed</div><div class="value" id="kpiOrders">0</div></div></div>
            <div class="card"><div class="card-body"><div class="text-muted">Orders Completed</div><div class="value" id="kpiCompleted">0</div></div></div>
            <div class="card"><div class="card-body"><div class="text-muted">Total Spend (‚Çπ)</div><div class="value" id="kpiSpend">0</div></div></div>
          </div>
          <div class="card">
            <div class="card-body">
              <h6 class="mb-2">Recent Activity</h6>
              <ul class="list-group" id="recentActivity"></ul>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- BROWSE CROPS (pulls from farmerProducts) -->
    <section class="dashboard-card d-none" id="sec-browse">
      <h4 class="text-primary mb-3">Browse Crops from Farmers</h4>
      <div class="row g-2 mb-2">
        <div class="col-md-4"><input id="searchCrop" class="form-control" placeholder="Search crop..."></div>
        <div class="col-md-3">
          <select id="availabilityFilter" class="form-select">
            <option value="Available">Available</option>
            <option value="all">All</option>
            <option value="Sold Out">Sold Out</option>
          </select>
        </div>
        <div class="col-md-5 text-end">
          <button class="btn btn-outline-primary btn-sm" onclick="exportBrowsePDF()">Export as PDF</button>
          <button class="btn btn-outline-success btn-sm" onclick="exportBrowseExcel()">Export Excel</button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light"><tr>
            <th>#</th><th>Crop</th><th>Qty (kg)</th><th>Price/kg (‚Çπ)</th><th>Image</th><th>Status</th><th>Action</th>
          </tr></thead>
          <tbody id="browseTable"></tbody>
        </table>
      </div>
    </section>
    <!-- ORDERS -->
    <section class="dashboard-card d-none" id="sec-orders">
      <h4 class="text-primary mb-3">Orders Management</h4>
      <div class="row g-2 mb-2">
        <div class="col-md-8"></div>
        <div class="col-md-4 text-end">
          <button class="btn btn-outline-primary btn-sm" onclick="exportOrdersPDF()">Export as PDF</button>
          <button class="btn btn-outline-success btn-sm" onclick="exportOrdersExcel()">Export Excel</button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light"><tr>
            <th>#</th><th>Crop</th><th>Qty</th><th>Farmer</th><th>Price/kg</th><th>Total (‚Çπ)</th><th>Status</th><th>Actions</th>
          </tr></thead>
          <tbody id="ordersTable"></tbody>
        </table>
      </div>
    </section>

    <!-- WEATHER -->
    <section class="dashboard-card d-none" id="sec-weather">
      <h4 class="text-primary mb-3">Local Weather</h4>
      <div class="row g-2 mb-2">
        <div class="col-md-4"><input id="weatherCity" class="form-control" placeholder="City (or leave blank to use Profile)"></div>
        <div class="col-md-4 d-flex gap-2">
          <button class="btn btn-primary" onclick="getWeather()">Get Weather</button>
          <button class="btn btn-outline-secondary" onclick="locateAndWeather()">Use My Location</button>
        </div>
      </div>
      <div id="weatherCard" class="card d-none">
        <div class="card-body">
          <h5 id="wCity" class="card-title"></h5>
          <div id="wDetails" class="small"></div>
        </div>
      </div>
      <div class="text-muted small mt-2"> Check your weather forecast in your city.</div>
    </section>

    <!-- MAP -->
    <section class="dashboard-card d-none" id="sec-map">
      <h4 class="text-primary mb-3">üó∫Ô∏è Trader & Farmer Map</h4>

      <div class="row g-3">
        <!-- Controls Column -->
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="mb-3">Search & Controls</h6>
              <div class="mb-2">
                <input id="mapSearch" class="form-control" placeholder="Search location or market...">
                <div id="searchSuggestions" class="mt-1" style="max-height:150px;overflow:auto;"></div>
              </div>
              <div class="d-grid gap-2 mb-3">
                <button class="btn btn-primary" onclick="mapSearchPlace()">Search & Pin</button>
                <button class="btn btn-success" onclick="calculateRoute()">Calculate Route</button>
                <button class="btn btn-warning" onclick="clearRoute()">Clear Route</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="enableDynamicLocation()">üìç Live Location</button>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="toggleFarmers" onchange="toggleFarmerMarkers()" checked>
                <label class="form-check-label" for="toggleFarmers">Show Registered Farmers</label>
              </div>
              <div class="mb-3">
                <label class="form-label">Map Style</label>
                <select id="mapStyleSelect" class="form-select" onchange="switchMapStyle(this.value)">
                  <option value="streets">Detailed Streets</option>
                  <option value="satellite">High-Resolution Satellite</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Weather Overlay</label>
                <select id="weatherOverlaySelect" class="form-select" onchange="toggleWeatherOverlay(this.value)">
                  <option value="none">None</option>
                  <option value="rain">Rainfall</option>
                </select>
              </div>
              <div id="routeInfo" class="small text-muted"></div>
            </div>
          </div>
        </div>

        <!-- Map Column -->
        <div class="col-lg-8 map-col">
          <div class="map-wrapper">
            <div id="map"></div>
            <div id="mapLegend" style="position:absolute;left:12px;bottom:12px;background:rgba(255,255,255,0.9);padding:8px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.08);font-size:12px;">
              <div><strong>Legend</strong></div>
              <div><span style="display:inline-block;width:12px;height:12px;background:#28a745;border-radius:50%;margin-right:6px;"></span> Farmer</div>
              <div><span style="display:inline-block;width:12px;height:12px;background:var(--brand);border-radius:50%;margin-right:6px;"></span> You</div>
              <div style="margin-top:6px;"><small class="text-muted">Satellite: high-res imagery</small></div>
            </div>
          </div>
        </div>
      </div>

      <p class="text-muted small mt-2">
        View trader and farmer locations in real time. Toggle farmers, calculate routes, or switch to satellite view.
      </p>
    </section>


    <!-- GOVT SCHEMES -->
    <section class="dashboard-card d-none" id="sec-schemes">
      <h4 class="text-primary mb-3">Govt Schemes & Resources</h4>
      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="quickOpen('https://agmarknet.gov.in/')">Agmarknet</button>
        <button class="btn btn-outline-primary btn-sm" onclick="quickOpen('https://mausam.imd.gov.in/')">IMD Weather</button>
        <button class="btn btn-outline-primary btn-sm" onclick="quickOpen('https://pmkisan.gov.in/')">PM-KISAN</button>
        <button class="btn btn-outline-primary btn-sm" onclick="quickOpen('https://farmer.gov.in/')">farmer.gov.in</button>
        <button class="btn btn-outline-primary btn-sm" onclick="quickOpen('https://agricoop.gov.in/en')">Min. of Agriculture</button>
      </div>
    </section>

    <!-- BROWSER -->
    <section class="dashboard-card d-none" id="sec-browser">
      <h4 class="text-primary mb-3">Burauza üåê</h4>
      <ul class="nav nav-pills mb-2">
        <li class="nav-item"><button class="nav-link active" id="tabWeb" onclick="switchWebMode('web')">Web</button></li>
        <li class="nav-item"><button class="nav-link" id="tabSearch" onclick="switchWebMode('search')">Search</button></li>
      </ul>

      <div class="row g-2 browser-toolbar mb-2">
        <div class="col-12 col-md-auto">
          <div class="btn-group">
            <button class="btn btn-outline-secondary btn-sm" onclick="miniBack()">‚üµ</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="miniForward()">‚ü∂</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="miniReload()">‚ü≥</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="miniHome()">üè†</button>
          </div>
        </div>
        <div class="col-12 col-md"><input id="browserUrl" class="form-control" placeholder="URL or search terms"/></div>
        <div class="col-12 col-md-auto d-flex gap-2">
          <button class="btn btn-primary btn-sm" onclick="loadSite()">Go</button>
          <button class="btn btn-outline-primary btn-sm" onclick="openNewTab()">Open in New Tab</button>
        </div>
      </div>

      <div id="browserAlert" class="alert alert-warning py-2 px-3 d-none small">
        Site blocked from embedding. Use <a href="#" onclick="openNewTab()">Open in New Tab</a>.
      </div>

      <iframe id="browserFrame" src="https://www.google.com" width="100%" height="420"
              style="border:1px solid #ced4da; border-radius:10px;"
              sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-popups-to-escape-sandbox"></iframe>
    </section>

    <!-- CHAT & CALLS -->
    <section class="dashboard-card d-none" id="sec-chat">
      <h4 class="text-primary mb-3">Chat & Calls with Farmers</h4>
      <div class="row g-3">
        <div class="col-lg-5">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="mb-2">Chat</h6>
              <div class="mb-2">
                <select id="chatPeer" class="form-select"></select>
              </div>
              <div id="chatBox"></div>
              <div class="input-group mt-2">
                <input id="chatMsg" class="form-control" placeholder="Type a message...">
                <button class="btn btn-primary" onclick="sendChat()">Send</button>
              </div>
              <div class="form-text">Works instantly if both dashboards are open on same origin (BroadcastChannel). Otherwise still syncs via storage when refreshed.</div>
            </div>
          </div>
        </div>
        <div class="col-lg-7">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="mb-2">Voice Call (WebRTC, peer-to-peer)</h6>
              <div class="call-grid">
                <div>
                  <div class="mb-2"><video id="localVideo" autoplay playsinline muted></video></div>
                  <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="startCall()">Start Call (Offer)</button>
                    <button class="btn btn-outline-danger" onclick="hangup()">Hang Up</button>
                  </div>
                </div>
                <div>
                  <div class="mb-2"><video id="remoteVideo" autoplay playsinline></video></div>
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="answerCall()">Answer (when Offer arrives)</button>
                  </div>
                </div>
              </div>
              <hr>
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">Manual Offer/Answer (paste to other side)</label>
                  <textarea id="sdpLocal" class="form-control sdp" placeholder="Local SDP (copy me)"></textarea>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Paste Remote SDP then click ‚ÄúApply Remote‚Äù</label>
                  <textarea id="sdpRemote" class="form-control sdp" placeholder="Paste remote SDP here"></textarea>
                  <div class="d-grid mt-2"><button class="btn btn-secondary" onclick="applyRemote()">Apply Remote</button></div>
                </div>
              </div>
              <div class="form-text mt-2">
                Auto-signaling works when both sides are open on the same origin (uses BroadcastChannel <code>ftc_call</code>).  
                For cross-device, exchange the Offer/Answer text via WhatsApp/SMS and press ‚ÄúApply Remote‚Äù.
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  <!-- GRAIN QUALITY SCANNER -->
    <section class="dashboard-card d-none" id="sec-grain">
      <h4 class="text-primary mb-3">üåæ Grain Quality Scanner</h4>
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-body">
          <h6 class="mb-2">Grain Quality Scanner</h6>
          <p class="small text-muted">Upload or capture an image to automatically detect grain type and scan quality.</p>
          <div class="mb-2">
            <label class="form-label">Grain Type</label>
            <select id="grainType" class="form-select">
              <option value="auto">Auto-detect</option>
              <option value="wheat">Wheat</option>
              <option value="rice">Rice</option>
              <option value="maize">Maize</option>
            </select>
          </div>
          <h6 class="mb-2">Upload or Capture Grain Image</h6>
              <input type="file" id="grainFile" accept="image/*" class="form-control mb-2">
              <button class="btn btn-outline-primary me-2" onclick="captureFromCamera()">üì∑ Capture from Camera</button>
              <button class="btn btn-primary" onclick="scanGrain()">Scan Quality</button>
              <div id="grainResult" class="mt-2"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card h-100">
         <div class="card-body">
              <h6 class="mb-2">Quality Metrics</h6>
              <canvas id="grainCanvas" width="300" height="200" style="border:1px solid #dee2e6;"></canvas>
              <div id="grainMetrics" class="mt-2 small"></div>
              <canvas id="qualityChart" width="300" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="row g-3 mt-3">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h6 class="mb-2">Scan History</h6>
              <div id="scanHistory"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
<!-- NOTIFICATIONS -->
    <section class="dashboard-card d-none" id="sec-notifications">
      <h4 class="text-primary mb-3">Notifications</h4>
      <ul class="list-group" id="notifList"></ul>
      <div class="mt-2 d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" onclick="seedNotifications()">Seed Demo Alerts</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearNotifications()">Clear</button>
      </div>
    </section>

  </div>

  <!-- PRICE PREDICTION -->
  <section class="dashboard-card d-none" id="sec-prediction">
    <h4 class="text-primary mb-3">Price Prediction üìà</h4>
    <div class="row g-3">
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="mb-2">Predict Crop Price</h6>
            <p class="small text-muted">Enter crop details to get a price prediction based on market trends.</p>
            <div class="mb-2">
              <label class="form-label">Crop Type</label>
              <select id="predictCropType" class="form-select">
                <option value="wheat">Wheat</option>
                <option value="rice">Rice</option>
                <option value="maize">Maize</option>
                <option value="soybean">Soybean</option>
                <option value="cotton">Cotton</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Quantity (kg)</label>
              <input type="number" id="predictQuantity" class="form-control" min="1" placeholder="Enter quantity">
            </div>
            <div class="mb-2">
              <label class="form-label">Location</label>
              <input id="predictLocation" class="form-control" placeholder="e.g., Mumbai, Maharashtra">
            </div>
            <button class="btn btn-primary" onclick="predictPrice()">Predict Price</button>
            <div id="predictionResult" class="mt-2"></div>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="mb-2">Prediction History</h6>
            <div id="predictionHistory"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PROFILE MODAL -->
  <div class="modal fade" id="profileModal" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" onsubmit="event.preventDefault(); saveProfile(); bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();">
        <div class="modal-header">
          <h5 class="modal-title">Edit Profile</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2"><label class="form-label">Name</label><input id="m_profName" class="form-control"></div>
          <div class="mb-2"><label class="form-label">Mobile</label><input id="m_profMobile" class="form-control" maxlength="10"></div>
          <div class="mb-2"><label class="form-label">Location</label><input id="m_profLocation" class="form-control"></div>
          <div class="mb-2"><label class="form-label">Profile Picture</label><input type="file" id="profPicFile" class="form-control" accept="image/*"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" type="submit">Save</button></div>
      </form>
    </div>
  </div>
  <!-- ORDER MODAL -->
  <div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Place Order</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Crop</label>
            <div class="form-control-plaintext fw-bold" id="orderCropName">‚Äî</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Price per kg</label>
            <div class="form-control-plaintext" id="orderPrice">‚Çπ‚Äî</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Available Quantity</label>
            <div class="form-control-plaintext" id="orderAvailableQty">‚Äî kg</div>
          </div>
          <div class="mb-3">
            <label for="orderQty" class="form-label">Quantity (kg)</label>
            <input type="number" class="form-control" id="orderQty" min="1" step="1" onchange="updateOrderTotal()" oninput="updateOrderTotal()">
          </div>
          <div class="mb-3">
            <label class="form-label">Total Amount</label>
            <div class="form-control-plaintext fw-bold text-success" id="orderTotal">‚Çπ0.00</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="submitOrder()">Place Order</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTACT MODAL -->
  <div class="modal fade" id="contactModal" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" onsubmit="event.preventDefault(); submitContact(); bootstrap.Modal.getInstance(document.getElementById('contactModal')).hide();">
        <div class="modal-header">
          <h5 class="modal-title">Contact Us</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Name</label>
            <input id="contactName" class="form-control" placeholder="Your name" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Email</label>
            <input id="contactEmail" class="form-control" type="email" placeholder="your.email@example.com" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Message</label>
            <textarea id="contactMessage" class="form-control" rows="4" placeholder="Your message..." required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Send</button>
        </div>
      </form>
    </div>
  </div>

  <!-- TOASTS -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    
    
    /***************
     * STATE
     ***************/
  const MAPTILER_KEY = "J4ApQMnvSEpc03xhAn3m"; // user-provided key
  const MAP_STYLE_STREETS = `https://api.maptiler.com/maps/streets/style.json?key=${MAPTILER_KEY}`;
  const MAP_STYLE_SATELLITE = `https://api.maptiler.com/maps/hybrid/style.json?key=${MAPTILER_KEY}`;
  const ROUTE_SOURCE = 'routeSource', ROUTE_LAYER = 'routeLayer';

  let map = null, mapInitialized = false, searchMarker = null, currentLocation = null;

    let notifs = [];
    let traderOrders = [];
    const farmerListings = () => {
      return JSON.parse(localStorage.getItem("farmerProducts") || "[]");
    };
    // ‚ÄúFarmer orders‚Äù (for mirroring placed orders so farmer sees them)
    const readFarmerOrders = () => JSON.parse(localStorage.getItem("farmerOrders") || "[]");



    // Encryption functions using Web Crypto API
    async function deriveKey(passphrase) {
      const encoder = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        'raw',
        encoder.encode(passphrase),
        'PBKDF2',
        false,
        ['deriveKey']
      );
      return crypto.subtle.deriveKey(
        {
          name: 'PBKDF2',
          salt: encoder.encode('KrishiVyaparSalt'),
          iterations: 100000,
          hash: 'SHA-256'
        },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        false,
        ['encrypt', 'decrypt']
      );
    }

    async function encryptData(data, passphrase) {
      const key = await deriveKey(passphrase);
      const encoder = new TextEncoder();
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const encrypted = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv },
        key,
        encoder.encode(JSON.stringify(data))
      );
      return { encrypted: Array.from(new Uint8Array(encrypted)), iv: Array.from(iv) };
    }

    async function decryptData(encryptedData, passphrase) {
      const key = await deriveKey(passphrase);
      const decrypted = await crypto.subtle.decrypt(
        { name: 'AES-GCM', iv: new Uint8Array(encryptedData.iv) },
        key,
        new Uint8Array(encryptedData.encrypted)
      );
      const decoder = new TextDecoder();
      return JSON.parse(decoder.decode(decrypted));
    }

    // Load trader data from localStorage first, then sync with server
    async function loadTraderData() {
      const passphrase = 'KrishiVyaparSETU2023';

      // Load from localStorage immediately for persistence across refreshes
      const encOrders = localStorage.getItem("traderOrders");
      if (encOrders) {
        try {
          traderOrders = await decryptData(JSON.parse(encOrders), passphrase);
        } catch (e) {
          console.warn('Failed to decrypt traderOrders, using empty array');
          traderOrders = [];
        }
      } else {
        traderOrders = [];
      }

      const encNotifs = localStorage.getItem("notifications_trader");
      if (encNotifs) {
        try {
          notifs = await decryptData(JSON.parse(encNotifs), passphrase);
        } catch (e) {
          console.warn('Failed to decrypt notifications_trader, using empty array');
          notifs = [];
        }
      } else {
        notifs = [];
      }

      // Then try to sync with server
      try {
        const response = await fetch('/load_trader_data');
        if (response.ok) {
          const data = await response.json();
          traderOrders = data.orders || [];
          notifs = data.notifications || [];
          // Update local storage with server data (encrypted)
          localStorage.setItem("traderOrders", JSON.stringify(await encryptData(traderOrders, passphrase)));
          localStorage.setItem("notifications_trader", JSON.stringify(await encryptData(notifs, passphrase)));
        }
      } catch (e) {
        console.warn('Failed to sync trader data with server, using localStorage data:', e);
      }

      updateKPIs();
      renderOrders();
      renderNotifs();
    }

    // Save trader data to server periodically or on changes
    async function saveTraderData() {
      try {
        const data = {
          orders: traderOrders,
          notifications: notifs
        };
        const response = await fetch('/save_trader_data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!response.ok) {
          console.warn('Failed to save trader data to server');
        }
      } catch (e) {
        console.warn('Error saving trader data:', e);
      }
    }

    // DOM
    const bellBadge = document.getElementById('bellBadge');
    const bellBtn = document.getElementById('bellBtn');

    // Section switching
    const sections = ["overview","browse","orders",
    "weather","map","schemes","browser","chat","grain","prediction","plant","notifications"];
    function openSection(name) {
  // Close sidebar if open
  const off = bootstrap.Offcanvas.getInstance(document.getElementById('mainMenu'));
  if (off) off.hide();

  // Toggle all dashboard sections
  const sections = ["overview","browse","orders","weather","map","schemes","browser","chat","grain","prediction"];
  sections.forEach(s => {
    const el = document.getElementById('sec-' + s);
    if (el) el.classList.toggle('d-none', s !== name);
  });

  // Section-specific renderers
  if(name==='map'){ setTimeout(()=>{ if(!mapInitialized) initMap(); else map.resize(); },220); }
  if (name === "overview") updateKPIs();
  if (name === "browse") renderBrowse();
  if (name === "orders") renderOrders();
  if (name === "notifications") renderNotifs();
}

    // Initialize on page load
    function onLoadInit(){
      loadProfile();
      loadTraderData();
      loadPeers();
      renderScanHistory();
      initMap();
      seedFarmerProductsIfEmpty();
      seedDemoFarmers();
    }

    // default landing
    openSection("overview");

    // Call init on load


    onLoadInit();
    // Auto-get location if not set
    const profile = JSON.parse(localStorage.getItem("currentTraderProfile") || "{}");
    if (!profile.location) {
      getCurrentLocation();
    }
    // Auto-fill prediction location if empty
    if (!document.getElementById('predictLocation').value.trim()) {
      getPredictionLocation();
    }

    /***************
     * PROFILE
     ***************/
    function loadProfile(){
      const p = JSON.parse(localStorage.getItem("currentTraderProfile") || "{}");
      document.getElementById('profName').value = p.name || "";
      document.getElementById('profMobile').value = p.mobile || "";
      document.getElementById('profLocation').value = p.location || "";
      document.getElementById('m_profName').value = p.name || "";
      document.getElementById('m_profMobile').value = p.mobile || "";
      document.getElementById('m_profLocation').value = p.location || "";
      setAvatar(p.name);
      document.getElementById('ddName').textContent = p.name || "Trader";
      // Also register user into shared ‚Äúusers‚Äù list for map discovery
      if (p.name && p.location) {
        // Try to geocode once and store coords on the user object
        async function reverseGeocode(lat, lon) {
  try {
    const r = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`,
      {
        headers: {
          "User-Agent": "KrishiVyaparSETU/1.0 (support@krishivyaparsetu.com)",
        },
      }
    );
    const j = await r.json();
    return j.display_name || null;
  } catch (e) {
    console.warn("reverseGeocode error", e);
    return null;
  }
}

        geocode(p.location).then(g=>{
          const users = JSON.parse(localStorage.getItem("users")||"[]").filter(u=>!(u.role==="trader" && u.mobile===p.mobile));
          users.push({ role:"trader", fullName:p.name, mobile:p.mobile, lat:g?.lat, lon:g?.lon });
          localStorage.setItem("users", JSON.stringify(users));
        });
      }
    }
    function setAvatar(name){
      const initials = (name||"T").trim().split(/\s+/).map(s=>s[0]?.toUpperCase()).slice(0,2).join('') || 'T';
      document.getElementById('avatarInitials').textContent = initials;
    }
    function saveProfile(){
      const p = {
        name: (document.getElementById('m_profName').value || document.getElementById('profName').value).trim(),
        mobile: (document.getElementById('m_profMobile').value || document.getElementById('profMobile').value).trim(),
        location: (document.getElementById('m_profLocation').value || document.getElementById('profLocation').value).trim()
      };
      localStorage.setItem("currentTraderProfile", JSON.stringify(p));
      document.getElementById('profName').value = p.name;
      document.getElementById('profMobile').value = p.mobile;
      document.getElementById('profLocation').value = p.location;
      document.getElementById('m_profName').value = p.name;
      document.getElementById('m_profMobile').value = p.mobile;
      document.getElementById('m_profLocation').value = p.location;
      setAvatar(p.name);
      document.getElementById('ddName').textContent = p.name || "Trader";
      showToast("Profile saved successfully.");
      loadPeers(); // refresh chat peers
    }
    document.getElementById('logoutBtn').addEventListener('click', ()=> window.location.href="login.html");

    /***************
     * KPIs & Activity
     ***************/
    function updateKPIs(){
      const listings = farmerListings().filter(p=>p.status==="Available").length;
      const orders = traderOrders.length;
      const completed = traderOrders.filter(o=>o.status==="Completed").length;
      const spend = traderOrders.filter(o=>o.status!=="Declined" && o.status!=="Cancelled")
        .reduce((s,o)=>s + (Number(o.qty||0)*Number(o.price||0)), 0);
      document.getElementById('kpiListings').textContent = String(listings);
      document.getElementById('kpiOrders').textContent = String(orders);
      document.getElementById('kpiCompleted').textContent = String(completed);
      document.getElementById('kpiSpend').textContent = String(spend.toFixed(2));
      updateBell();
      renderRecent();
    }
    function renderRecent(){
      const ul = document.getElementById('recentActivity');
      ul.innerHTML = "";
      const list = (JSON.parse(localStorage.getItem("notifications_trader")||"[]")).slice(0,8);
      if(!list.length){ ul.innerHTML = `<li class="list-group-item text-muted">No activity yet.</li>`; return; }
      list.forEach(n=>{
        const li = document.createElement('li');
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `<span>${n.text}</span><small class="text-muted">${new Date(n.ts).toLocaleString()}</small>`;
        ul.appendChild(li);
      });
    }

    /***************
     * BROWSE CROPS
     ***************/
    const browseTable = document.getElementById('browseTable');
    const searchCrop = document.getElementById('searchCrop');
    const availabilityFilter = document.getElementById('availabilityFilter');

    function renderBrowse(){
      const term = (searchCrop.value||"").toLowerCase().trim();
      const filter = availabilityFilter.value;
    const rows = (farmerListings()||[]).map((p,i)=>({ ...p, _i:i })).filter(p => (filter==='all'?true:p.status===filter)).filter(p => term===''?true:p.cropName.toLowerCase().includes(term));
      browseTable.innerHTML = "";
      rows.forEach((p, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${p.cropName}</td>
          <td>${p.quantity}</td>
          <td>‚Çπ${p.price}</td>
          <td>${p.imageUrl ? `<img src="${p.imageUrl}" width="60" height="45" style="object-fit:cover;border-radius:6px;">` : 'N/A'}</td>
          <td><span class="badge ${p.status==='Available'?'bg-success':'bg-secondary'}">${p.status}</span></td>
          <td>${p.status==='Available'
            ? `<button class="btn btn-sm btn-primary" onclick="openOrderModal('${p.cropName}', ${p.price})">Order</button>`
            : `<button class="btn btn-sm btn-secondary" disabled>Order</button>`}
          </td>`;
        browseTable.appendChild(tr);
      });
      updateKPIs();
    }
    searchCrop.addEventListener('input', renderBrowse);
    availabilityFilter.addEventListener('change', renderBrowse);

    function exportBrowseExcel(){
      const data = [["Crop","Qty (kg)","Price (‚Çπ)","Status"], ...farmerListings().map(p=>[p.cropName,p.quantity,p.price,p.status])];
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "Farmers");
      XLSX.writeFile(wb, "farmer_listings.xlsx");
    }
    async function exportBrowsePDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Farmer Listings", 14, 18);
      const rows = farmerListings().map((p,i)=>[i+1,p.cropName,String(p.quantity),String(p.price),p.status]);
      doc.autoTable({ head:[["#","Crop","Qty","Price","Status"]], body: rows, startY:24 });
      doc.save("farmer_listings.pdf");
    }

    /***************
     * ORDERS (Trader side)
     ***************/
    function renderOrders(){
      const tb = document.getElementById('ordersTable');
      tb.innerHTML = "";
      traderOrders.forEach((o,i)=>{
        const total = (Number(o.qty||0)*Number(o.price||0)).toFixed(2);
        let statusBadgeClass = 'bg-secondary';
        if (o.status === 'Pending') statusBadgeClass = 'bg-warning text-dark';
        else if (o.status === 'Accepted') statusBadgeClass = 'bg-info text-dark';
        else if (o.status === 'Declined') statusBadgeClass = 'bg-danger';
        else if (o.status === 'Completed') statusBadgeClass = 'bg-success';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${o.crop}</td>
          <td>${o.qty}</td>
          <td>${o.farmer || '‚Äî'}</td>
          <td>‚Çπ${o.price}</td>
          <td>‚Çπ${total}</td>
          <td><span class="badge ${statusBadgeClass}">${o.status}</span></td>
          <td class="d-flex gap-1">
            ${o.status==='Accepted'?`<button class="btn btn-sm btn-outline-primary" onclick="completeOrder(${i})">Mark Completed</button>`:''}
            <button class="btn btn-sm btn-danger" onclick="deleteOrder(${i})">Delete</button>
          </td>`;
        tb.appendChild(tr);
      });
      updateKPIs();
    }
    async function persistTraderOrders(){
      const passphrase = 'KrishiVyaparSETU2023';
      localStorage.setItem("traderOrders", JSON.stringify(await encryptData(traderOrders, passphrase)));
      renderOrders();
      updateKPIs();
      saveTraderData();
    }
async function completeOrder(i){
  traderOrders[i].status = "Completed";
  await persistTraderOrders();
  addNotif(`Order completed: ${traderOrders[i].crop}`, "success");
  // mirror on farmer side if exists
  const fOrders = readFarmerOrders();
  if (traderOrders[i].mirrorId != null && fOrders[traderOrders[i].mirrorId]) {
    fOrders[traderOrders[i].mirrorId].status = "Completed";
    localStorage.setItem("farmerOrders", JSON.stringify(fOrders));
  }
}

    function deleteOrder(i){
      if(!confirm("Delete this order?")) return;
      const o = traderOrders[i];
      traderOrders.splice(i,1);
      persistTraderOrders();
      addNotif(`Order deleted: ${o.crop}`, "warning");
      // Also remove mirrored order from farmer side if it exists
      const fOrders = readFarmerOrders();
      if (o.mirrorId != null && fOrders[o.mirrorId]) {
        fOrders.splice(o.mirrorId, 1); // Remove the mirrored order
        localStorage.setItem("farmerOrders", JSON.stringify(fOrders));
      }
    }

    // Quick order modal (inline, no Bootstrap modal to keep simple)
    function openOrderModal(cropName, pricePerKg){
      // Populate modal fields
      document.getElementById('orderCropName').textContent = cropName;
      document.getElementById('orderPrice').textContent = `‚Çπ${pricePerKg}`;
      const farmerListingsData = farmerListings();
      const cropData = farmerListingsData.find(item => item.cropName === cropName);
      if (cropData) {
        document.getElementById('orderAvailableQty').textContent = `${cropData.quantity} kg`;
      }
      document.getElementById('orderQty').value = '';
      updateOrderTotal();
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('orderModal'));
      modal.show();
    }
    function updateOrderTotal(){
      const qty = parseFloat(document.getElementById('orderQty').value) || 0;
      const price = parseFloat(document.getElementById('orderPrice').textContent.replace('‚Çπ', '')) || 0;
      const total = qty * price;
      document.getElementById('orderTotal').textContent = `‚Çπ${total.toFixed(2)}`;
    }
    function submitOrder(){
      const cropName = document.getElementById('orderCropName').textContent;
      const qty = parseFloat(document.getElementById('orderQty').value);
      const price = parseFloat(document.getElementById('orderPrice').textContent.replace('‚Çπ', ''));
      if (!qty || qty <= 0) {
        alert("Enter a valid quantity.");
        return;
      }
      placeOrder(cropName, qty, price);
      // Close modal
      bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide();
    }
   function placeOrder(crop, qty, price){
  const prof = JSON.parse(localStorage.getItem("currentTraderProfile")||"{}");
  
  // Check available quantity from farmerListings
  const farmerListingsData = farmerListings();
  const cropData = farmerListingsData.find(item => item.cropName === crop);
  
  if (!cropData) {
    alert("Selected crop not found.");
    return;
  }

  // Validate requested quantity against available quantity
  if (qty > cropData.quantity) {
    alert(`Cannot place order for ${qty} kg. Only ${cropData.quantity} kg available.`);
    return;
  }

  // Mirror to farmerOrders so the farmer dashboard sees it
  const fOrders = readFarmerOrders();
  const farmerOrderIndex = fOrders.length; // Get index before pushing
  fOrders.push({ crop, qty, trader: prof.name || "Trader", price, status:"Pending", mirrorId: null }); // mirrorId will be set by farmer

  localStorage.setItem("farmerOrders", JSON.stringify(fOrders));

  // Add to traderOrders with a reference to the farmer's order
  traderOrders.push({ crop, qty, price, status:"Pending", farmer:"‚Äî", mirrorId: farmerOrderIndex });
  persistTraderOrders();
  addNotif(`Order placed: ${qty} kg ${crop} @ ‚Çπ${price}/kg`);

  // Also ring the farmer (notification storage)
  const fNotifs = JSON.parse(localStorage.getItem("notifications")||"[]");
  fNotifs.unshift({ text:`New order from ${prof.name||'Trader'}: ${qty} kg ${crop} @ ‚Çπ${price}/kg`, level:"success", ts:new Date().toISOString(), read:false });
  localStorage.setItem("notifications", JSON.stringify(fNotifs));
}


    // Listen for changes in farmerOrders to update traderOrders
    window.addEventListener('storage', (event) => {
      if (event.key === 'farmerOrders') {
        const newFarmerOrders = JSON.parse(event.newValue || "[]");
        let traderOrdersChanged = false;

        traderOrders.forEach((tOrder, tIdx) => {
          if (tOrder.mirrorId != null && newFarmerOrders[tOrder.mirrorId]) {
            const fOrder = newFarmerOrders[tOrder.mirrorId];
            if (tOrder.status !== fOrder.status) {
              tOrder.status = fOrder.status;
              traderOrdersChanged = true;
              if (fOrder.status === "Accepted") {
                addNotif(`Order for ${tOrder.crop} has been Accepted by farmer.`, "success");
              } else if (fOrder.status === "Declined") {
                addNotif(`Order for ${tOrder.crop} has been Declined by farmer.`, "warning");
              }
            }
          }
        });

        if (traderOrdersChanged) {
          persistTraderOrders(); // Re-render and save if any status changed
        }
      }
            if (event.key === 'farmerProducts') {
        // Re-render browse table when farmer products change
        renderBrowse();
        updateKPIs(); // Since listings count may change
      }
      if (event.key === 'users') {
        // Re-load chat peers and re-render chat when users change
        loadPeers();
        renderChat();
        // Update map farmer markers if toggle is on
        if (document.getElementById('toggleFarmers').checked) {
          toggleFarmerMarkers();
        }
      }
    });


    /***************
     * NOTIFICATIONS
     ***************/
    function addNotif(text, level="success"){
      notifs.unshift({ text, level, ts:new Date().toISOString(), read:false });
      persistNotifs();
      showToast(text, level==="warning"?"warning":"success");
    }
    function persistNotifs(){
      localStorage.setItem("notifications_trader", JSON.stringify(notifs));
      renderNotifs();
      updateBell();
      renderRecent();
    }
    function renderNotifs(){
      const ul = document.getElementById('notifList');
      ul.innerHTML = "";
      if(!notifs.length){ ul.innerHTML = `<li class="list-group-item text-muted">No notifications.</li>`; return; }
      notifs.slice(0,20).forEach((n,idx)=>{
        const li = document.createElement('li');
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `<span>${n.read?'':'<strong class="me-1">‚Ä¢</strong>'}${n.text}</span>
                        <span class="d-flex align-items-center gap-2">
                          <small class="text-muted">${new Date(n.ts).toLocaleString()}</small>
                          <button class="btn btn-sm ${n.read?'btn-outline-secondary':'btn-outline-success'}" onclick="toggleNotifRead(${idx})">${n.read?'Unread':'Mark read'}</button>
                        </span>`;
        ul.appendChild(li);
      });
    }
    function toggleNotifRead(i){
      notifs[i].read = !notifs[i].read;
      persistNotifs();
    }
    function clearNotifications(){ notifs = []; persistNotifs(); }
    function seedNotifications(){
      ["Welcome to Trader Dashboard!","Browse crops and place orders.","Use Chat & Calls to contact farmers."].forEach((t,i)=>notifs.push({text:t, level:"success", ts:new Date(Date.now()-i*600000).toISOString(), read:false}));
      persistNotifs();
    }
    function updateBell(){
      const unread = notifs.filter(n=>!n.read).length;
      bellBadge.textContent = String(unread);
      bellBadge.classList.toggle('d-none', unread===0);
    }
    bellBtn.addEventListener('click', ()=>openSection('notifications'));

    /***************
     * WEATHER (Open-Meteo)
     ***************/
    async function getWeather(){
      const city = document.getElementById('weatherCity').value.trim();
      if (!city){
        const p = JSON.parse(localStorage.getItem("currentTraderProfile")||"{}");
        if (p.location) { await weatherByPlace(p.location); return; }
        alert("Enter a city or set your profile location."); return;
      }
      await weatherByPlace(city);
    }
    async function weatherByPlace(place){
      const geo = await geocode(place);
      if(!geo){ alert("Place not found."); return; }
      await fetchWeather(geo.lat, geo.lon, geo.display_name);
    }
    function locateAndWeather(){
      if(!navigator.geolocation){ alert("Geolocation not supported."); return; }
      navigator.geolocation.getCurrentPosition(async pos=>{
        await fetchWeather(pos.coords.latitude, pos.coords.longitude, "My Location");
      }, ()=>alert("Unable to get your location."));
    }
    async function fetchWeather(lat, lon, label){
      try{
        const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m&timezone=auto`);
        const j = await r.json();
        const c = j.current || {};
        document.getElementById('wCity').textContent = label;
        document.getElementById('wDetails').innerHTML = `
          <div>Temperature: <strong>${c.temperature_2m ?? "‚Äì"}¬∞C</strong></div>
          <div>Humidity: <strong>${c.relative_humidity_2m ?? "‚Äì"}%</strong></div>
          <div>Wind: <strong>${c.wind_speed_10m ?? "‚Äì"} km/h</strong></div>`;
        document.getElementById('weatherCard').classList.remove('d-none');
      }catch(e){ alert("Weather fetch failed."); }
    }


  // ============================================================
  // Geocoding (Nominatim)
  // ============================================================
  async function geocode(place){ try{ const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`); const json=await r.json(); if(json.length){ const {lat, lon, display_name}=json[0]; return { lat:parseFloat(lat), lon:parseFloat(lon), display_name }; } } catch(e){ console.warn('geocode err', e); } return null; }

  // ============================================================
  // Map (MapLibre) Initialization & functions
  // ============================================================
function initMap(){
  if(mapInitialized) return;

  map = new maplibregl.Map({
    container: 'map',
    style: MAP_STYLE_STREETS,
    center: [83.89263, 18.30255],
    zoom: 6
  });

  map.addControl(new maplibregl.NavigationControl(), 'top-right');
  map.addControl(new maplibregl.ScaleControl({ maxWidth: 120, unit: 'metric' }));

  map.on('load', () => {
    map.resize();

    // ‚úÖ Step 4: Auto-enable dynamic location tracking
    if (navigator.geolocation) {
      enableDynamicLocation();
    } else {
      console.warn("Geolocation not supported on this browser.");
    }

    // build users source geojson
    const users = (JSON.parse(localStorage.getItem('users')||'[]')).filter(u=>u.lat && u.lon).map((u,i)=>({ type:'Feature', properties:{ id:i, fullName:u.fullName || '', role:u.role || '', location:u.location || '' }, geometry:{ type:'Point', coordinates:[u.lon, u.lat] } }));
    const usersGeoJSON = { type:'FeatureCollection', features: users };
    try{ if(map.getLayer('clusters')) map.removeLayer('clusters'); if(map.getLayer('cluster-count')) map.removeLayer('cluster-count'); if(map.getLayer('unclustered-point')) map.removeLayer('unclustered-point'); if(map.getSource('users')) map.removeSource('users'); }catch(e){}
    map.addSource('users', { type:'geojson', data: usersGeoJSON, cluster:true, clusterMaxZoom: 14, clusterRadius: 50 });
    map.addLayer({ id:'clusters', type:'circle', source:'users', filter:['has','point_count'], paint:{ 'circle-color':['step',['get','point_count'],'#51bbd6',10,'#f1f075',30,'#f28cb1'], 'circle-radius':['step',['get','point_count'],15,10,20,30,25] } });
    map.addLayer({ id:'cluster-count', type:'symbol', source:'users', filter:['has','point_count'], layout:{ 'text-field':'{point_count_abbreviated}', 'text-font':['Open Sans Bold','Arial Unicode MS Bold'], 'text-size':12 } });
    map.addLayer({ id:'unclustered-point', type:'circle', source:'users', filter:['!', ['has','point_count']], paint:{ 'circle-color':['case',['==',['get','role'],'farmer'],'#28a745','var(--brand)'], 'circle-radius':10, 'circle-stroke-width':2, 'circle-stroke-color':'#ffffff' } });
    map.on('click', 'unclustered-point', (e)=>{ const feat = e.features[0]; const props = feat.properties; const coords = feat.geometry.coordinates.slice(); const html = `<strong>${escapeHtml(props.fullName || 'User')}</strong><div class='tiny'>${escapeHtml(props.role || '')} ‚Ä¢ ${escapeHtml(props.location || '')}</div>`; new maplibregl.Popup().setLngLat(coords).setHTML(html).addTo(map); });
    map.on('click', 'clusters', (e)=>{ const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] }); const clusterId = features[0].properties.cluster_id; map.getSource('users').getClusterExpansionZoom(clusterId, (err, zoom)=>{ if(err) return; map.easeTo({ center: features[0].geometry.coordinates, zoom }); }); });
    // route source
    if(!map.getSource(ROUTE_SOURCE)) map.addSource(ROUTE_SOURCE, { type:'geojson', data:{ type:'FeatureCollection', features:[] } });
    if(!map.getLayer(ROUTE_LAYER)) map.addLayer({ id:ROUTE_LAYER, type:'line', source:ROUTE_SOURCE, layout:{ 'line-join':'round','line-cap':'round' }, paint:{ 'line-color':'#1976d2','line-width':6,'line-opacity':0.9 } });
    // initial markers
    try{ const p = JSON.parse(localStorage.getItem('currentTraderProfile')||'{}'); if(p.location) geocode(p.location).then(g=>{ if(g) addUserMarker(g.lat, g.lon, p.name||'Trader'); }); if(navigator.geolocation) navigator.geolocation.getCurrentPosition(pos=>{ currentLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude }; addUserMarker(currentLocation.lat, currentLocation.lon, 'Me'); map.flyTo({ center:[currentLocation.lon, currentLocation.lat], zoom: 12 }); }, ()=>{}); }catch(e){ console.warn('init markers err', e); }
  }); 
  mapInitialized = true; }

  function addUserMarker(lat, lon, title='You'){ const el=document.createElement('div'); el.style.cssText='width:14px;height:14px;border-radius:50%;background:var(--brand);border:2px solid white;box-shadow:0 1px 4px rgba(0,0,0,0.3);'; new maplibregl.Marker({ element: el }).setLngLat([lon, lat]).setPopup(new maplibregl.Popup({ offset:10 }).setText(title)).addTo(map); }

async function mapSearchPlace(){
  const q = document.getElementById('mapSearch').value.trim();
  if (!q) return alert('Enter a place name.');

  try {
    const r = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`,
      {
        headers: {
          "User-Agent": "KrishiVyaparSETU/1.0 (support@krishivyaparsetu.com)",
          "Accept-Language": "en"
        }
      }
    );

    const data = await r.json();
    console.log("Nominatim response:", data);

    if (!data.length) {
      alert('No results found ‚Äî try another place or check internet connection.');
      return;
    }

    const loc = data[0];
    const lng = parseFloat(loc.lon), lat = parseFloat(loc.lat);

    // Remove previous marker
    if (searchMarker) searchMarker.remove();

    // Create a new marker for search result
    const el = document.createElement('div');
    el.style.cssText =
      'width:20px;height:20px;border-radius:50%;background:#ff5722;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.25);';
    searchMarker = new maplibregl.Marker({ element: el })
      .setLngLat([lng, lat])
      .addTo(map);
    searchMarker.setPopup(
      new maplibregl.Popup({ offset: 12 }).setHTML(`<b>${loc.display_name}</b>`)
    ).togglePopup();

    // Center map on result
    map.flyTo({ center: [lng, lat], zoom: 12 });

    // Show search suggestion below input
    const sug = document.getElementById('searchSuggestions');
    if (sug) {
      sug.innerHTML = '';
      const item = document.createElement('div');
      item.className = 'small text-muted';
      item.textContent = loc.display_name;
      sug.appendChild(item);
    }

  } catch (e) {
    console.warn('Search error:', e);
    alert('Search failed. Please check your internet or try again later.');
  }
}

  async function calculateRoute(){ if(!searchMarker) return alert('Search and pin a destination first.'); if(!currentLocation){ const p=JSON.parse(localStorage.getItem('currentTraderProfile')||'{}'); if(p.location){ const g=await geocode(p.location); if(g) currentLocation={ lat:g.lat, lon:g.lon }; } if(!currentLocation) return alert('No origin available. Enable geolocation or set profile location.'); } const dest = searchMarker.getLngLat(); const coords = `${currentLocation.lon},${currentLocation.lat};${dest.lng},${dest.lat}`; try{ const resp = await fetch(`https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`); const json = await resp.json(); if(!json.routes||!json.routes.length) return alert('No route found'); const route = json.routes[0].geometry; if(map.getSource(ROUTE_SOURCE)) map.getSource(ROUTE_SOURCE).setData({ type:'FeatureCollection', features:[{ type:'Feature', geometry: route }]}); else { map.addSource(ROUTE_SOURCE, { type:'geojson', data:{ type:'FeatureCollection', features:[{ type:'Feature', geometry: route }] } }); map.addLayer({ id:ROUTE_LAYER, type:'line', source:ROUTE_SOURCE, layout:{ 'line-join':'round','line-cap':'round' }, paint:{ 'line-color':'#1976d2','line-width':6 } }); } const bbox=turf.bbox(route); map.fitBounds([[bbox[0], bbox[1]],[bbox[2], bbox[3]]], { padding:40 }); document.getElementById('routeInfo').textContent = `Distance: ${(json.routes[0].distance/1000).toFixed(2)} km ‚Äî Duration: ${(json.routes[0].duration/60).toFixed(0)} min`; }catch(e){ console.warn('route err', e); alert('Routing failed'); } }

  function clearRoute(){ try{ if(map.getSource(ROUTE_SOURCE)) map.getSource(ROUTE_SOURCE).setData({ type:'FeatureCollection', features:[] }); document.getElementById('routeInfo').textContent=''; }catch(e){ console.warn('clear route', e); } }
  function locateMe(){ if(!navigator.geolocation) return alert('Geolocation not supported'); navigator.geolocation.getCurrentPosition(pos=>{ currentLocation={ lat:pos.coords.latitude, lon:pos.coords.longitude }; addUserMarker(currentLocation.lat, currentLocation.lon, 'My location'); map.flyTo({ center:[currentLocation.lon, currentLocation.lat], zoom:12 }); }, ()=> alert('Unable to get your location.')); }
  async function enableDynamicLocation() {
 if (!navigator.geolocation) {
  alert("Geolocation not supported. Using IP-based lookup...");
  const res = await fetch("https://ipapi.co/json/");
  const j = await res.json();
  const { latitude, longitude, city } = j;
  map.flyTo({ center: [longitude, latitude], zoom: 10 });

  const el = document.createElement("div");
  el.style.cssText = "width:16px;height:16px;border-radius:50%;background:#0d6efd;border:2px solid white;";
  window.dynamicMarker = new maplibregl.Marker({ element: el })
    .setLngLat([longitude, latitude])
    .setPopup(new maplibregl.Popup({ offset: 10 }).setText(city || "Approximate location"))
    .addTo(map);
}
(async () => {
  try {
    const res = await fetch("https://ipapi.co/json/");
    const j = await res.json();
    const { latitude, longitude, city } = j;
    map.flyTo({ center: [longitude, latitude], zoom: 10 });
    new maplibregl.Marker().setLngLat([longitude, latitude]).addTo(map);
    alert(`Using approximate location: ${city}`);
  } catch (e) {
    alert("Could not get approximate location either.");
  }
})();



  navigator.geolocation.watchPosition(
    (pos) => {
      const { latitude, longitude } = pos.coords;
      currentLocation = { lat: latitude, lon: longitude };

      // Update or add marker
      if (window.dynamicMarker) window.dynamicMarker.remove();
      const el = document.createElement("div");
      el.style.cssText =
        "width:16px;height:16px;border-radius:50%;background:#0d6efd;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.25);";
      window.dynamicMarker = new maplibregl.Marker({ element: el })
        .setLngLat([longitude, latitude])
        .setPopup(new maplibregl.Popup({ offset: 10 }).setText("üìç Live Position"))
        .addTo(map);

      // Center map smoothly
      map.flyTo({ center: [longitude, latitude], zoom: 12 });

      // Optionally update profile location field (city detection)
      reverseGeocode(latitude, longitude).then((locName) => {
        if (locName) {
          document.getElementById("profLocation").value = locName;
          const prof = JSON.parse(localStorage.getItem("currentTraderProfile") || "{}");
          prof.location = locName;
          localStorage.setItem("currentTraderProfile", JSON.stringify(prof));
        }
      });
    },
    (err) => {
      console.warn("Geo error:", err);
      alert("Unable to access live location. Please enable GPS.");
    },
    { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
  );
}

  function switchMapStyle(v){ if(!map) return; if(v==='satellite'){ map.setStyle(MAP_STYLE_SATELLITE); } else { map.setStyle(MAP_STYLE_STREETS); } }
  function toggleWeatherOverlay(v){ if(v==='none'){ if(map.getLayer('weatherLayer')){ try{ map.removeLayer('weatherLayer'); map.removeSource('weatherSource'); }catch(e){} } return; } if(v==='rain'){ if(map.getSource('weatherSource')){ try{ map.removeLayer('weatherLayer'); map.removeSource('weatherSource'); }catch(e){} } map.addSource('weatherSource', { type:'raster', tiles:[ 'https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=YOUR_OPENWEATHER_KEY' ], tileSize:256 }); map.addLayer({ id:'weatherLayer', type:'raster', source:'weatherSource', paint:{ 'raster-opacity':0.6 } }); } }
  function refreshClusters(){ if(!map || !map.getSource) return; const users = JSON.parse(localStorage.getItem('users')||'[]').filter(u=>u.lat && u.lon).map((u,i)=>({ type:'Feature', properties:{ id:i, fullName:u.fullName||'', role:u.role||'', location:u.location||'' }, geometry:{ type:'Point', coordinates:[u.lon, u.lat] } })); const usersGeoJSON={ type:'FeatureCollection', features: users }; try{ if(map.getSource('users')) map.getSource('users').setData(usersGeoJSON); }catch(e){ console.warn('refresh clusters error', e); } }
  function toggleFarmerMarkers(){ if(!map) return; const checked=document.getElementById('toggleFarmers').checked; try{ map.setLayoutProperty('clusters', 'visibility', checked? 'visible' : 'none'); map.setLayoutProperty('cluster-count', 'visibility', checked? 'visible' : 'none'); map.setLayoutProperty('unclustered-point', 'visibility', checked? 'visible' : 'none'); }catch(e){ console.warn('toggleFarmerMarkers', e); } }


    /***************
     * EMBEDDED BROWSER
     ***************/
    const HOME_URL = "https://www.google.com/";
    const frame = document.getElementById('browserFrame');
    const urlInput = document.getElementById('browserUrl');
    const alertBox = document.getElementById('browserAlert');
    const tabWeb = document.getElementById('tabWeb');
    const tabSearch = document.getElementById('tabSearch');
    let webMode = "web";
    const hist = { stack:[HOME_URL], index:0 };
    let loadTimer=null, currentLoadingUrl="";

    function switchWebMode(mode){
      webMode=mode;
      tabWeb.classList.toggle('active', mode==='web');
      tabSearch.classList.toggle('active', mode==='search');
      urlInput.placeholder = mode==='web' ? "Type a URL (https://...)" : "Search the web (e.g., onion prices)";
      if(mode==='search') urlInput.focus();
    }
    function isLikelyDomain(s){ return /^(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+[a-z0-9][a-z0-9-]{0,61}[a-z0-9]$/i.test(s); }
    function normalizeUrl(input){
      const s = input.trim();
      if(!s) return HOME_URL;
      if (webMode==='search' || (!s.includes('.') && !s.includes('/'))) return "https://www.google.com/search?q="+encodeURIComponent(s);
      if (/^[a-zA-Z]+:\/\//.test(s)) return s;
      if (/^\d{1,3}(\.\d{1,3}){3}(?::\d{1,5})?$/.test(s)) return "http://"+s;
      if (isLikelyDomain(s)) return "https://"+s;
      return "https://www.google.com/search?q="+encodeURIComponent(s);
    }
    function setFrameSrc(url){
      clearTimeout(loadTimer);
      alertBox.classList.add('d-none'); frame.classList.remove('loading');
      frame.src = url; currentLoadingUrl = url; frame.classList.add('loading');
      loadTimer = setTimeout(()=>{
        try{
          if (frame.src===currentLoadingUrl && frame.contentWindow.location.href==='about:blank'){
            alertBox.classList.remove('d-none'); showToast("Page may block embedding. Use 'Open in New Tab'.", "warning");
          }
        }catch(e){}
        frame.classList.remove('loading');
      }, 3500);
      frame.onload = ()=>{ clearTimeout(loadTimer); alertBox.classList.add('d-none'); frame.classList.remove('loading');
        try{ if(frame.contentWindow.location.href!=='about:blank') urlInput.value = frame.contentWindow.location.href; }catch(e){} };
      frame.onerror = ()=>{ clearTimeout(loadTimer); alertBox.classList.remove('d-none'); frame.classList.remove('loading'); };
    }
    function pushToHistory(url){
      if (hist.stack[hist.index] !== url){ hist.stack = hist.stack.slice(0, hist.index+1); hist.stack.push(url); hist.index++; }
    }
    function loadSite(){ const url = normalizeUrl(urlInput.value); pushToHistory(url); setFrameSrc(url); }
    function openNewTab(){ const u = hist.stack[hist.index] || HOME_URL; window.open(u, "_blank"); }
    function miniHome(){ urlInput.value = HOME_URL; pushToHistory(HOME_URL); setFrameSrc(HOME_URL); }
    function miniBack(){ if (hist.index>0){ hist.index--; const url = hist.stack[hist.index]; urlInput.value=url; setFrameSrc(url);} }
    function miniForward(){ if (hist.index<hist.stack.length-1){ hist.index++; const url = hist.stack[hist.index]; urlInput.value=url; setFrameSrc(url);} }
    function miniReload(){ const url = hist.stack[hist.index] || HOME_URL; setFrameSrc(url); }
    urlInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); loadSite(); } });

    function quickOpen(url){ openSection('browser'); urlInput.value = url; pushToHistory(url); setFrameSrc(url); }

    /***************
     * CHAT
     ***************/
    const chatBox = document.getElementById('chatBox');
    const chatMsg = document.getElementById('chatMsg');
    const chatPeer = document.getElementById('chatPeer');
    const CHAT_CHANNEL = new BroadcastChannel('ftc_chat'); // auto signaling (same origin)
    function loadPeers(){
      // Peers from users list (farmers only)
      const farmers = (JSON.parse(localStorage.getItem("users")||"[]")).filter(u=>u.role==="farmer");
      chatPeer.innerHTML = "";
      if (!farmers.length) chatPeer.innerHTML = `<option value="">No farmers registered</option>`;
      farmers.forEach(f=>{
        const opt = document.createElement('option');
        opt.value = f.mobile || f.fullName || "farmer";
        opt.textContent = `${f.fullName||'Farmer'} ${f.mobile?('('+f.mobile+')'):''}`;
        chatPeer.appendChild(opt);
      });
    }
    function chatKey(room){ return `chat_${room}`; }
    function currentRoom(){ return chatPeer.value || "farmer"; }
    function renderChat(){
      const list = JSON.parse(localStorage.getItem(chatKey(currentRoom())) || "[]");
      chatBox.innerHTML = "";
      list.slice(-100).forEach(m=>{
        const wrap = document.createElement('div');
        wrap.className = "msg "+(m.role==="me"?"me":"");
        wrap.innerHTML = `<div class="bubble"><div>${m.text}</div><div class="tiny mt-1">${new Date(m.ts).toLocaleTimeString()}</div></div>`;
        chatBox.appendChild(wrap);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    function sendChat(){
      const text = chatMsg.value.trim();
      if(!text) return;
      const k = chatKey(currentRoom());
      const list = JSON.parse(localStorage.getItem(k) || "[]");
      const msg = { role:"me", text, ts: Date.now() };
      list.push(msg);
      localStorage.setItem(k, JSON.stringify(list));
      renderChat();
      chatMsg.value="";
      addNotif(`Message sent to ${currentRoom()}`);
      // Broadcast to peer tabs
      CHAT_CHANNEL.postMessage({ room: currentRoom(), text, ts: msg.ts, from: "trader" });
    }
    CHAT_CHANNEL.onmessage = (ev)=>{
      const { room, text, ts, from } = ev.data || {};
      if (!room || !text) return;
      const k = chatKey(room);
      const list = JSON.parse(localStorage.getItem(k) || "[]");
      list.push({ role:"peer", text, ts: ts||Date.now() });
      localStorage.setItem(k, JSON.stringify(list));
      renderChat();
      addNotif(`New message from ${room}`, "success");
    };
    chatPeer.addEventListener('change', renderChat);
    chatMsg.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(); } });

    /***************
     * CALLS (WebRTC)
     ***************/
    const CALL_CHANNEL = new BroadcastChannel('ftc_call'); // auto signaling (same origin)
    let pc = null, localStream=null, remoteStream=null, makingOffer=false;
    const pcConfig = { iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }] };
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const sdpLocal = document.getElementById('sdpLocal');
    const sdpRemote = document.getElementById('sdpRemote');

    async function ensureStreams(){
      if (localStream) return;
      localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:true });
      localVideo.srcObject = localStream;
    }
    function newPC(){
      if (pc) pc.close();
      pc = new RTCPeerConnection(pcConfig);
      remoteStream = new MediaStream();
      remoteVideo.srcObject = remoteStream;
      pc.ontrack = (e)=> e.streams[0].getTracks().forEach(t=> remoteStream.addTrack(t));
      pc.onicecandidate = (e)=> {
        if (e.candidate) {
          // Auto signaling to peer tabs
          CALL_CHANNEL.postMessage({ type:"ice", candidate: e.candidate });
        }
      };
      pc.onconnectionstatechange = ()=> {
        if (pc.connectionState === "connected") showToast("Call connected");
        if (pc.connectionState === "failed") showToast("Call failed", "warning");
        if (pc.connectionState === "disconnected" || pc.connectionState === "closed") showToast("Call ended", "warning");
      };
    }
    async function startCall(){
      await ensureStreams();
      newPC();
      localStream.getTracks().forEach(t=> pc.addTrack(t, localStream));
      try{
        makingOffer = true;
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        sdpLocal.value = JSON.stringify(pc.localDescription);
        // Auto broadcast to peer
        CALL_CHANNEL.postMessage({ type:"offer", sdp: pc.localDescription });
        addNotif("Outgoing call‚Ä¶");
      } finally { makingOffer = false; }
    }
    async function answerCall(){
      await ensureStreams();
      if (!pc) newPC();
      localStream.getTracks().forEach(t=> pc.addTrack(t, localStream));
      // If an offer already received via channel & stored in sdpRemote textarea, apply it then answer
      await applyRemote();
      if (pc.signalingState === "have-remote-offer"){
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        sdpLocal.value = JSON.stringify(pc.localDescription);
        CALL_CHANNEL.postMessage({ type:"answer", sdp: pc.localDescription });
        addNotif("Answered call");
      } else {
        showToast("No remote offer yet. Wait for Offer, paste it, then Answer.", "warning");
      }
    }
    async function applyRemote(){
      if (!pc) newPC();
      let desc;
      try{ desc = JSON.parse(sdpRemote.value.trim()); }catch(e){ desc = null; }
      if (!desc){ showToast("Paste a valid SDP first.", "warning"); return; }
      await pc.setRemoteDescription(desc);
      showToast(`Applied remote ${desc.type.toUpperCase()}`);
    }
    function hangup(){
      try{ pc && pc.close(); }catch(e){}
      pc=null;
      if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
      showToast("Call ended", "warning");
    }

    // Auto signaling handlers
    CALL_CHANNEL.onmessage = async (ev)=>{
      const msg = ev.data || {};
      if (!msg.type) return;
      if (msg.type === "offer"){
        // Save to textarea so user can see/share too
        sdpRemote.value = JSON.stringify(msg.sdp);
        addNotif("Incoming call ‚Äî press Answer");
      } else if (msg.type === "answer"){
        sdpRemote.value = JSON.stringify(msg.sdp);
        if (pc && pc.signalingState === "have-local-offer"){
          await pc.setRemoteDescription(msg.sdp);
          addNotif("Peer answered ‚Äî connecting...");
        }
      } else if (msg.type === "ice"){
        try{
          if (pc && msg.candidate) await pc.addIceCandidate(msg.candidate);
        }catch(e){ /* ignore race */ }
      }
    };


    
     /***************
     * GRAIN QUALITY SCANNER
     ***************/
    let model;
    let isModelLoading = false;
    async function loadModel(){
      if (model || isModelLoading) return;
      isModelLoading = true;
      try {
        // Try loading a more reliable model or use fallback
        showToast("Loading AI model for grain analysis...");
        model = await tf.loadLayersModel('https://storage.googleapis.com/tfjs-models/tfjs/mobilenet_v1_0.25_224/model.json');
        showToast("AI model loaded successfully!");
      } catch (e) {
        console.warn("AI model failed to load:", e);
        showToast("AI model unavailable, using enhanced image analysis.", "warning");
        // Create a mock model for fallback
        model = {
          predict: async (tensor) => {
            // Return mock predictions for grain types
            return tf.tensor([[0.3, 0.4, 0.3]]); // wheat, rice, maize probabilities
          }
        };
      } finally {
        isModelLoading = false;
      }
    }

    async function captureFromCamera(){
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.createElement('video');
        video.srcObject = stream;
        video.style.display = 'block';
        video.style.width = '300px';
        video.style.height = '200px';
        video.play();
        const canvas = document.getElementById('grainCanvas');
        const ctx = canvas.getContext('2d');
        video.onloadedmetadata = () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          stream.getTracks().forEach(track => track.stop());
          video.remove();
          // Now scan the captured image
          scanFromCanvas();
        };
      } catch (e) {
        alert('Camera access denied or not supported.');
      }
    }

    async function scanGrain(){
      const fileInput = document.getElementById('grainFile');
      const resultDiv = document.getElementById('grainResult');
      const canvas = document.getElementById('grainCanvas');
      const metricsDiv = document.getElementById('grainMetrics');
      const ctx = canvas.getContext('2d');

      if (!fileInput.files[0]) {
        resultDiv.innerHTML = '<div class="alert alert-warning">Please select an image first.</div>';
        return;
      }

      const file = fileInput.files[0];
      const img = new Image();
      img.onload = async () => {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        await scanFromCanvas();
      };
      img.src = URL.createObjectURL(file);
    }

    async function scanFromCanvas(){
      const resultDiv = document.getElementById('grainResult');
      const canvas = document.getElementById('grainCanvas');
      const metricsDiv = document.getElementById('grainMetrics');
      const ctx = canvas.getContext('2d');
      let grainType = document.getElementById('grainType').value;
      let detectedGrainType = grainType;

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      if (grainType === 'auto') {
        // Calculate average r, g, b
        let totalR = 0, totalG = 0, totalB = 0;
        for (let i = 0; i < data.length; i += 4) {
          totalR += data[i];
          totalG += data[i+1];
          totalB += data[i+2];
        }
        const avgR = totalR / (data.length / 4);
        const avgG = totalG / (data.length / 4);
        const avgB = totalB / (data.length / 4);
        if (avgR > 180 && avgG > 180 && avgB > 180) detectedGrainType = 'rice';
        else if (avgR > 150 && avgG > 150 && avgB < 100) detectedGrainType = 'wheat';
        else detectedGrainType = 'maize';
      }

      // Enhanced analysis: adjust heuristics based on grain type
      let healthy = 0, damaged = 0, foreign = 0;
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i], g = data[i+1], b = data[i+2];
        if (grainType === 'wheat') {
          if (r > 150 && g > 150 && b < 100) healthy++; // Yellowish for wheat
          else if (r > 120 && g < 100 && b < 100) damaged++; // Reddish
          else foreign++;
        } else if (grainType === 'rice') {
          if (r > 180 && g > 180 && b > 180) healthy++; // White for rice
          else if (r < 100 && g < 100 && b < 100) damaged++; // Dark spots
          else foreign++;
        } else { // maize or default
          if (r > 150 && g > 100 && b < 100) healthy++; // Yellow-orange
          else if (r < 100 && g < 100 && b < 100) damaged++;
          else foreign++;
        }
      }

      const total = healthy + damaged + foreign;
      const quality = ((healthy / total) * 100).toFixed(1);
      const damage = ((damaged / total) * 100).toFixed(1);
      const foreignMatter = ((foreign / total) * 100).toFixed(1);

      // Display results
      resultDiv.innerHTML = `
        <div class="alert alert-success">
          <h6>Scan Complete (${grainType})</h6>
          <p>Overall Quality: <strong>${quality}%</strong></p>
          <p>Damage Level: <strong>${damage}%</strong></p>
          <p>Foreign Matter: <strong>${foreignMatter}%</strong></p>
        </div>
      `;

      metricsDiv.innerHTML = `
        <div>Healthy Pixels: ${healthy.toLocaleString()}</div>
        <div>Damaged Pixels: ${damaged.toLocaleString()}</div>
        <div>Foreign Pixels: ${foreign.toLocaleString()}</div>
        <div>Total Pixels: ${total.toLocaleString()}</div>
      `;

      // Chart
      const chartCanvas = document.getElementById('qualityChart');
      new Chart(chartCanvas, {
        type: 'pie',
        data: {
          labels: ['Healthy', 'Damaged', 'Foreign'],
          datasets: [{
            data: [healthy, damaged, foreign],
            backgroundColor: ['#28a745', '#dc3545', '#6c757d']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // Save to history
      const history = JSON.parse(localStorage.getItem('grainScanHistory') || '[]');
      history.push({
        grainType,
        quality,
        damage,
        foreignMatter,
        timestamp: new Date().toISOString()
      });
      localStorage.setItem('grainScanHistory', JSON.stringify(history));
      renderScanHistory();

      showToast("Grain quality scanned successfully!");
    }

    function renderScanHistory(){
      const history = JSON.parse(localStorage.getItem('grainScanHistory') || '[]');
      const div = document.getElementById('scanHistory');
      div.innerHTML = '';
      if (!history.length) {
        div.innerHTML = '<div>No scans yet.</div>';
        return;
      }
      history.slice(-5).forEach((h, i) => {
        div.innerHTML += `<div class="mb-1">${h.grainType}: ${h.quality}% healthy on ${new Date(h.timestamp).toLocaleString()}</div>`;
      });
    }


    /***************
     * MISSING FUNCTIONS
     ***************/
    function showToast(message, type = "success") {
      const container = document.getElementById('toastContainer');
      const toastEl = document.createElement('div');
      toastEl.className = `toast align-items-center text-bg-${type} border-0`;
      toastEl.setAttribute('role', 'alert');
      toastEl.setAttribute('aria-live', 'assertive');
      toastEl.setAttribute('aria-atomic', 'true');
      toastEl.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      container.appendChild(toastEl);
      const toast = new bootstrap.Toast(toastEl);
      toast.show();
      toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }

    function exportLocalDB() {
      const data = {
        traderProfile: JSON.parse(localStorage.getItem("currentTraderProfile") || "{}"),
        traderOrders: traderOrders,
        notifications: notifs,
        farmerProducts: farmerListings(),
        farmerOrders: readFarmerOrders(),
        users: JSON.parse(localStorage.getItem("users") || "[]"),
        grainScanHistory: JSON.parse(localStorage.getItem('grainScanHistory') || '[]')
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'trader_backup.json';
      a.click();
      URL.revokeObjectURL(url);
      showToast("Backup exported successfully!");
    }

    function seedFarmerProductsIfEmpty() {
      let products = JSON.parse(localStorage.getItem("farmerProducts") || "[]");
      if (products.length === 0) {
        products = [
          { cropName: "Wheat", quantity: 100, price: 20, status: "Available", imageUrl: "" },
          { cropName: "Rice", quantity: 50, price: 25, status: "Available", imageUrl: "" },
          { cropName: "Maize", quantity: 80, price: 18, status: "Available", imageUrl: "" }
        ];
        localStorage.setItem("farmerProducts", JSON.stringify(products));
        showToast("Demo farmer products seeded!");
      }
    }

    function seedDemoFarmers() {
      let users = JSON.parse(localStorage.getItem("users") || "[]");
      if (users.filter(u => u.role === "farmer").length === 0) {
        users.push(
          { role: "farmer", fullName: "Rajesh Kumar", mobile: "9876543210", lat: 28.6139, lon: 77.2090, location: "Delhi, India" },
          { role: "farmer", fullName: "Amit Singh", mobile: "9876543211", lat: 19.0760, lon: 72.8777, location: "Mumbai, India" },
          { role: "farmer", fullName: "Suresh Patel", mobile: "9876543212", lat: 13.0827, lon: 80.2707, location: "Chennai, India" }
        );
        localStorage.setItem("users", JSON.stringify(users));
        showToast("Demo farmers seeded for map!");
      }
    }

    function submitContact() {
      const name = document.getElementById('contactName').value.trim();
      const email = document.getElementById('contactEmail').value.trim();
      const message = document.getElementById('contactMessage').value.trim();
      if (!name || !email || !message) {
        showToast("Please fill all fields.", "warning");
        return;
      }
      // Simulate sending (in real app, send to server)
      showToast("Message sent successfully! We will get back to you soon.");
      // Clear form
      document.getElementById('contactName').value = '';
      document.getElementById('contactEmail').value = '';
      document.getElementById('contactMessage').value = '';
    }


    // Get prediction location from profile
    function getPredictionLocation() {
      const p = JSON.parse(localStorage.getItem("currentTraderProfile") || "{}");
      if (p.location) {
        document.getElementById('predictLocation').value = p.location;
      }
    }

    // Price prediction model
    let predictionModel = null;

    async function trainPredictionModel() {
      if (predictionModel) return;
      // Synthetic data for training
      const crops = ['wheat', 'rice', 'maize', 'soybean', 'cotton'];
      const data = [];
      for (let i = 0; i < 100; i++) {
        const crop = crops[Math.floor(Math.random() * crops.length)];
        const quantity = Math.random() * 100 + 10; // 10-110 kg
        const locationFactor = Math.random() * 0.5 + 0.75; // 0.75-1.25
        const basePrice = { wheat: 20, rice: 25, maize: 18, soybean: 30, cotton: 35 }[crop];
        const price = basePrice * locationFactor * (1 + Math.random() * 0.2 - 0.1); // variation
        data.push({ crop, quantity, locationFactor, price });
      }
      // Encode crop
      const cropIndex = crops.reduce((acc, c, i) => { acc[c] = i; return acc; }, {});
      const xs = tf.tensor2d(data.map(d => [cropIndex[d.crop], d.quantity, d.locationFactor]));
      const ys = tf.tensor2d(data.map(d => [d.price]));
      predictionModel = tf.sequential();
      predictionModel.add(tf.layers.dense({ inputShape: [3], units: 10, activation: 'relu' }));
      predictionModel.add(tf.layers.dense({ units: 1 }));
      predictionModel.compile({ optimizer: 'adam', loss: 'meanSquaredError' });
      await predictionModel.fit(xs, ys, { epochs: 50, verbose: 0 });
      showToast("Prediction model trained.");
    }

    async function predictPrice() {
      await trainPredictionModel();
      const cropType = document.getElementById('predictCropType').value;
      const quantity = parseFloat(document.getElementById('predictQuantity').value);
      const location = document.getElementById('predictLocation').value.trim();
      if (!cropType || !quantity || !location) {
        showToast("Please fill all fields.", "warning");
        return;
      }
      // Simple location factor
      const locationFactor = location.toLowerCase().includes('mumbai') ? 1.2 : location.toLowerCase().includes('delhi') ? 1.1 : 0.9;
      const crops = ['wheat', 'rice', 'maize', 'soybean', 'cotton'];
      const cropIndex = crops.indexOf(cropType);
      const input = tf.tensor2d([[cropIndex, quantity, locationFactor]]);
      const pred = predictionModel.predict(input);
      const predictedPriceKg = pred.dataSync()[0];
      const total = predictedPriceKg * quantity;
      document.getElementById('predictionResult').innerHTML = `<div class="alert alert-success">Predicted Price: ‚Çπ${predictedPriceKg.toFixed(2)}/kg<br>Total: ‚Çπ${total.toFixed(2)}</div>`;
      // Save to history
      const history = JSON.parse(localStorage.getItem('predictionHistory') || '[]');
      history.push({
        cropType,
        quantity,
        location,
        predictedPriceKg: predictedPriceKg.toFixed(2),
        total: total.toFixed(2),
        timestamp: new Date().toISOString()
      });
      localStorage.setItem('predictionHistory', JSON.stringify(history));
      renderPredictionHistory();
    }

    function renderPredictionHistory() {
      const history = JSON.parse(localStorage.getItem('predictionHistory') || '[]');
      const div = document.getElementById('predictionHistory');
      div.innerHTML = '';
      if (!history.length) {
        div.innerHTML = '<div>No predictions yet.</div>';
        return;
      }
      history.slice(-5).forEach(h => {
        div.innerHTML += `<div class="mb-1">${h.cropType} (${h.quantity}kg) @ ${h.location}: ‚Çπ${h.predictedPriceKg}/kg (Total: ‚Çπ${h.total}) on ${new Date(h.timestamp).toLocaleString()}</div>`;
      });
    }
  </script>
</body>
</html>
